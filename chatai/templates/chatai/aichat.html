{% extends "core/base.html" %}

{% block title %}AI Chat | RUHAH{% endblock %}

{% block page-header %}
  RUHAH AI Chat
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Regular content (scrolls with page, like studio_items) -->
    <div class="chat-messages">
        {% for message in messages %}
            <div class="chat-bubble {% if message.msg_is_from_user %}user-bubble{% else %}ruhah-bubble{% endif %} {% if message.msg_message_type == 'recommendation' %}recommendation-bubble{% endif %}">
                {% if message.msg_is_from_user %}
                    <div class="user-icon"></div>  <!-- Circle icon -->
                {% elif message.msg_message_type != 'recommendation' %}
                    <img src="{% static 'ruhah_icon.png' %}" alt="< >" class="ruhah-icon">  <!-- Your static icon; replace with actual path; hidden for recommendations -->
                {% endif %}
                <div class="bubble-content">
                    {% if message.msg_text %}
                        <p>{{ message.msg_text }}</p>
                    {% endif %}
                    {% if message.msg_image_url %}
                        <img src="{{ message.msg_image_url }}" alt="Reference Image" class="bubble-image">
                    {% endif %}
                    {% if message.msg_recommendations %}
                        <div class="recommendations-grid">
                            {% for rec in message.msg_recommendations %}
                                <div class="rec-item">
                                    <img src="{{ rec.main_image }}" alt="{{ rec.name }}">
                                    <p>${{ rec.price }}</p>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
    <!-- Fixed bottom bar (floating, like you described) -->
    <div class="chat-bar">
        <button onclick="location.href='{% url 'chatai:aichat' %}'">New</button>  <!-- Resets to virgin -->
        <button {% if not can_input %}disabled{% endif %}>Upload</button>  <!-- Disabled if max user messages reached -->
        <input type="text" placeholder="Type here (disabled for now)" {% if not can_input %}disabled{% endif %}>
        <button {% if not can_input %}disabled{% endif %}>Send</button>
        {% if reference_outfit_id %}
            <button onclick="location.href='{% url 'accounts:public_profile' profile_user.username %}#gridpics?outfit_id={{ reference_outfit_id }}'">Go Back</button>  <!-- Uses model-stored metadata -->
        {% endif %}
    </div>
</div>

<style>
    .chat-container {
        max-width: 800px;  /* Matches studio_tickets content-wrapper */
        margin: 0 auto;
        display: flex;
        flex-direction: column;
    }

    .chat-messages {
        padding: 10px;  /* Regular padding, page scrolls naturally */
    }

    .chat-bubble {
        display: flex;
        align-items: flex-start;
        margin-bottom: 10px;
        border: 1px solid black;  /* Thin black line like studio_tickets */
        border-radius: 4px;
        padding: 10px;
        word-break: break-word;  /* Like studio_tickets notes */
        max-width: 100%;  /* Matches recommendation grid width */
    }

    .user-bubble {
        background-color: #f0f0f0;  /* Soft grey */
        justify-content: flex-end;  /* User on right? Adjust if needed */
    }

    .ruhah-bubble {
        background-color: white;
    }

    .user-icon, .ruhah-icon {
        width: 20px;
        height: 20px;
        margin-right: 10px;  /* Total icon space: 20px + 10px = 30px */
    }

    .user-icon {
        border-radius: 50%;
        background-color: grey;  /* Simple circle */
    }

    .bubble-content {
        flex: 1;
    }

    .bubble-image {
        max-width: 100px;
        height: auto;
    }

    .recommendations-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);  /* 2 cols desktop; like studio_items */
        grid-gap: 10px;
    }

    .rec-item {
        border: 1px solid black;  /* Like contA in studio_items */
        text-align: center;
    }

    .rec-item img {
        width: 100%;
        height: auto;
        aspect-ratio: 1/1;  /* Square like you want */
        object-fit: cover;
    }

    /* New: Recommendation bubble adjustments */
    .recommendation-bubble {
        width: calc(100% - 30px);  /* Matches regular bubble width + icon space (adjust 30px if icon size/margin differs) */
    }
    .recommendation-bubble .ruhah-icon {
        display: none;  /* Hide icon for recommendations */
    }

    .chat-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: #f0f0f0;  /* Soft grey */
        padding: 10px;
        display: flex;
        justify-content: space-around;
        border-top: 1px solid black;
    }

    @media (max-width: 768px) {
        .recommendations-grid {
            grid-template-columns: repeat(1, 1fr);  /* 1 col mobile */
        }

        .chat-bubble {
            max-width: 100%;  /* Full width mobile */
        }

        .recommendation-bubble {
            width: 100%;  /* Full on mobile (no icon offset needed) */
        }
    }
</style>
{% endblock %}